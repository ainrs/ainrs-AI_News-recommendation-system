@router.get("/{news_id}", response_model=Dict[str, Any])
async def get_news_detail(
    news_id: str,
    user_id: Optional[str] = Query(None),
    db = Depends(get_mongodb_database),
    langchain_service = Depends(get_langchain_service_dep),
    embedding_service = Depends(get_embedding_service_dep),
    bert4rec_service = Depends(get_bert4rec_service_dep),
    trust_service = Depends(get_trust_analysis_service_dep),
    sentiment_service = Depends(get_sentiment_analysis_service_dep)
):
    """
    ë‰´ìŠ¤ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    ì‚¬ìš©ìê°€ ë‰´ìŠ¤ë¥¼ í´ë¦­í•  ë•Œ í˜¸ì¶œë˜ë©°, í•„ìš”í•œ ê²½ìš° ê³ ê¸‰ AI ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    try:
        # ë‰´ìŠ¤ ì¡´ì¬ í™•ì¸
        news_collection = db["news"]

        # ObjectIdë¡œ ë³€í™˜ ì‹œë„
        try:
            news_id_obj = ObjectId(news_id)
            news = await news_collection.find_one({"_id": news_id_obj})
        except:
            # ì‹¤íŒ¨í•˜ë©´ ë¬¸ìì—´ IDë¡œ ì‹œë„
            news = await news_collection.find_one({"_id": news_id})

        if not news:
            raise HTTPException(status_code=404, detail="News not found")

        # ì¡°íšŒìˆ˜ ì¦ê°€ ë° ìƒí˜¸ì‘ìš© ê¸°ë¡
        if user_id:
            # ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê¸°ë¡
            interaction_data = {
                "user_id": user_id,
                "news_id": str(news["_id"]),
                "type": "view",
                "created_at": datetime.utcnow()
            }

            # ìƒí˜¸ì‘ìš© ì €ì¥
            interaction_collection = db["user_interactions"]
            await interaction_collection.insert_one(interaction_data)

            # ë‰´ìŠ¤ ì¡°íšŒìˆ˜ ì¦ê°€
            await news_collection.update_one(
                {"_id": news["_id"]},
                {"$inc": {"view_count": 1}}
            )

        # ë‰´ìŠ¤ê°€ ê¸°ë³¸ ì •ë³´ë§Œ ìˆëŠ” ê²½ìš° (is_basic_info=True) ê³ ê¸‰ AI ë¶„ì„ ìˆ˜í–‰
        if news.get("is_basic_info", False) and news.get("content"):
            try:
                # ë¶„ì„ ì‹œì‘ ë¡œê·¸
                logger.info(f"ğŸ” ê¸°ì‚¬ ID {news_id}ì— ëŒ€í•œ ê³ ê¸‰ ë¶„ì„ ì‹œì‘")

                # ê¸°ì‚¬ì˜ ì œëª©ê³¼ ë‚´ìš©ì„ ê°€ì ¸ì˜´
                title = news.get("title", "")
                content = news.get("content", "")

                if len(content) >= 300:  # ì½˜í…ì¸  ê¸¸ì´ê°€ ì¶©ë¶„í•œ ê²½ìš°ë§Œ AI ì²˜ë¦¬
                    # 1. ì–¸ì–´ ê°ì§€ - ìµœì ì˜ ì„ë² ë”© ëª¨ë¸ ì„ íƒì„ ìœ„í•´
                    detected_lang = "ko"  # ê¸°ë³¸ê°’ì€ í•œêµ­ì–´
                    try:
                        # ë³¸ë¬¸ ì¼ë¶€ë§Œ ì‚¬ìš©í•˜ì—¬ ì–¸ì–´ ê°ì§€ (íš¨ìœ¨ì„±)
                        sample_text = content[:1000]
                        detected_lang = detect(sample_text)
                        logger.info(f"ê°ì§€ëœ ì–¸ì–´: {detected_lang}")
                    except LangDetectException:
                        logger.warning("ì–¸ì–´ ê°ì§€ ì‹¤íŒ¨, ê¸°ë³¸ê°’(í•œêµ­ì–´)ìœ¼ë¡œ ì„¤ì •")

                    # 2. ë³‘ë ¬ë¡œ ì—¬ëŸ¬ ë¶„ì„ ì‘ì—… ì‹¤í–‰
                    # ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ íƒœìŠ¤í¬ ìƒì„±
                    tasks = []

                    # 2.1 LangChain ë¶„ì„ (ìš”ì•½, í‚¤ì›Œë“œ ì¶”ì¶œ ë“±)
                    tasks.append(asyncio.create_task(
                        asyncio.to_thread(
                            langchain_service.analyze_news_sync,
                            title,
                            content
                        )
                    ))

                    # 2.2 ì„ë² ë”© ìƒì„± (ì–¸ì–´ì— ë§ëŠ” ëª¨ë¸ ì‚¬ìš©)
                    embedding_model = "news-ko"  # ê¸°ë³¸ í•œêµ­ì–´ ëª¨ë¸
                    if detected_lang in ["en", "de", "fr", "es", "it"]:
                        embedding_model = "multilingual"  # ì„œì–‘ì–´ëŠ” ë‹¤êµ­ì–´ ëª¨ë¸

                    tasks.append(asyncio.create_task(
                        asyncio.to_thread(
                            embedding_service.get_embedding_with_model,
                            content,
                            embedding_model
                        )
                    ))

                    # 2.3 ì‹ ë¢°ë„ ë¶„ì„
                    tasks.append(asyncio.create_task(
                        asyncio.to_thread(
                            trust_service.analyze_trust,
                            title,
                            content,
                            news.get("source", "")
                        )
                    ))

                    # 2.4 ê°ì • ë¶„ì„
                    tasks.append(asyncio.create_task(
                        asyncio.to_thread(
                            sentiment_service.analyze_sentiment,
                            content
                        )
                    ))

                    # ëª¨ë“  ì‘ì—… ëŒ€ê¸°
                    results = await asyncio.gather(*tasks, return_exceptions=True)

                    # ê²°ê³¼ íŒŒì‹±
                    ai_result = results[0] if not isinstance(results[0], Exception) else {"error": str(results[0])}
                    embedding_result = results[1] if not isinstance(results[1], Exception) else None
                    trust_result = results[2] if not isinstance(results[2], Exception) else None
                    sentiment_result = results[3] if not isinstance(results[3], Exception) else None

                    # ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•  ë°ì´í„° ì¤€ë¹„
                    update_data = {
                        "is_basic_info": False,  # ì™„ì „íˆ ì²˜ë¦¬ëœ ìƒíƒœë¡œ í‘œì‹œ
                        "updated_at": datetime.utcnow(),
                        "analyzed_at": datetime.utcnow(),
                        "language": detected_lang
                    }

                    # AI ë¶„ì„ ê²°ê³¼ ì ìš©
                    if not "error" in ai_result:
                        # ìš”ì•½ ì ìš©
                        update_data["summary"] = ai_result.get("summary", "")
                        update_data["keywords"] = ai_result.get("keywords", [])
                        update_data["ai_enhanced"] = True

                    # ì‹ ë¢°ë„ ì ìˆ˜ ê³„ì‚° ë° ì €ì¥
                    if trust_result:
                        trust_score = trust_result.get("score", 0.5)
                        update_data["trust_score"] = trust_score
                        update_data["trust_factors"] = trust_result.get("factors", [])
                    else:
                        # LangChain ê²°ê³¼ì—ì„œ ì‹ ë¢°ë„ ëŒ€ì²´ ì¶”ì¶œ
                        update_data["trust_score"] = min(1.0, float(ai_result.get("importance", 5)) / 10.0)

                    # ê°ì • ë¶„ì„ ê²°ê³¼ ì €ì¥
                    if sentiment_result:
                        sentiment_score = sentiment_result.get("score", 0)
                        update_data["sentiment_score"] = sentiment_score
                        update_data["sentiment_label"] = sentiment_result.get("label", "neutral")
                    else:
                        # LangChain ê²°ê³¼ì—ì„œ ê°ì • ë¼ë²¨ ëŒ€ì²´ ì¶”ì¶œ
                        sentiment_label = ai_result.get("sentiment", "neutral")
                        sentiment_score = 0
                        if sentiment_label == "positive":
                            sentiment_score = 0.7
                        elif sentiment_label == "negative":
                            sentiment_score = -0.7
                        update_data["sentiment_score"] = sentiment_score
                        update_data["sentiment_label"] = sentiment_label

                    # ì„ë² ë”© ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì €ì¥
                    if embedding_result is not None and len(embedding_result) > 0:
                        # ì„ë² ë”© ì €ì¥
                        embedding_doc = {
                            "news_id": str(news["_id"]),
                            "embedding": embedding_result,
                            "model": embedding_model,
                            "created_at": datetime.utcnow()
                        }
                        try:
                            await db["embeddings"].insert_one(embedding_doc)
                            update_data["has_embedding"] = True
                            update_data["embedding_model"] = embedding_model
                        except Exception as e:
                            logger.error(f"ì„ë² ë”© ì €ì¥ ì¤‘ ì˜¤ë¥˜: {str(e)}")

                    # ê¸°ì‚¬ ì—…ë°ì´íŠ¸
                    await news_collection.update_one(
                        {"_id": news["_id"]},
                        {"$set": update_data}
                    )

                    # BERT4Rec ëª¨ë¸ì— ê¸°ì‚¬ ì •ë³´ ì¶”ê°€
                    if user_id:
                        try:
                            bert4rec_service.add_interaction(user_id, str(news["_id"]), "view")
                        except Exception as e:
                            logger.error(f"BERT4Rec ìƒí˜¸ì‘ìš© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: {str(e)}")

                    # ì—…ë°ì´íŠ¸ëœ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
                    if isinstance(news["_id"], ObjectId):
                        news = await news_collection.find_one({"_id": news["_id"]})
                    else:
                        news = await news_collection.find_one({"_id": news["_id"]})

                    logger.info(f"âœ… ê¸°ì‚¬ ID {news_id} ê³ ê¸‰ ë¶„ì„ ì™„ë£Œ")
            except Exception as e:
                logger.error(f"AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                # ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ì¡´ ë‰´ìŠ¤ ë°ì´í„° ë°˜í™˜

        # MongoDB _idë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
        if "_id" in news and isinstance(news["_id"], ObjectId):
            news["_id"] = str(news["_id"])

        return news
    except Exception as e:
        logger.error(f"ë‰´ìŠ¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: {str(e)}")
        raise HTTPException(status_code=500, detail=f"Error getting news: {str(e)}")
