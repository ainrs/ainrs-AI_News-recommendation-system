# NVIPBION.AI 백엔드

## 2025-05-20 오류 수정 업데이트

### 수정된 주요 오류

1. **image_url 타입 불일치 문제 해결**
   - `recommendation.py`의 `NewsRecommendation` 모델에서 `image_url` 필드의 타입을 `HttpUrl`에서 `str`로 변경하여 직렬화 문제 해결
   - `news.py`의 `NewsBase` 및 `NewsSummary` 모델에서도 동일하게 타입 수정
   - 반환 값 일관성 확보를 위해 API 엔드포인트에서 HttpUrl 객체를 문자열로 변환하는 로직 추가

2. **ChromaDB 데이터베이스 오류 해결**
   - `rag_service.py`의 `_init_vectorstores` 메서드를 수정하여 손상된 DB 파일 감지 및 복구 기능 구현
   - 데이터베이스 파일("file is not a database") 오류가 발생할 경우 자동으로 파일을 삭제하고 새로 생성하는 로직 추가
   - ChromaDB와 관련된 "Could not connect to tenant default_tenant" 오류 해결

3. **누락된 임포트 추가**
   - `rag_service.py` 및 `main.py`에 `from bson.objectid import ObjectId` 추가하여 ID 처리 관련 오류 해결
   - 코드 내에서 사용되는 모듈이 명시적으로 임포트되도록 수정

4. **RAG 엔드포인트 예외 처리 강화**
   - `/api/v1/rag/search` 엔드포인트에 예외 처리를 추가하여 오류 발생 시 빈 배열을 반환하도록 수정
   - 프론트엔드에서 발생하는 500 내부 서버 오류 방지

### 기술적 개선사항

1. **타입 일관성 향상**
   - HTTP 응답에서 일관된 데이터 타입 반환을 위한 변환 로직 구현
   - Pydantic 모델 타입 정의 개선

2. **오류 복구 메커니즘 강화**
   - 데이터베이스 손상 시 자동 복구 기능 추가
   - 파일 시스템 오류에 대한 복원력 향상

3. **로깅 시스템 개선**
   - RAG 관련 오류에 대한 로깅 강화
   - 예외 처리 과정에서 상세한 오류 정보 기록

## 2025-05-19 오류 수정 업데이트

### 수정된 주요 오류

1. **비동기 함수(코루틴) 처리 오류 해결**
   - `langchain_service.py`에서 `sentiment_service.analyze_sentiment`와 `trust_service.calculate_trust_score` 함수 호출 시 코루틴 처리 문제 수정
   - 코루틴 객체를 올바르게 처리하는 코드로 수정하여 'coroutine was never awaited' 오류 해결
   - 새로운 루프 생성 후 처리 과정에서 코루틴 변수를 분리하여 안정적으로 처리하도록 개선

2. **결과 값 타입 처리 개선**
   - 'coroutine' object has no attribute 'get' 오류를 방지하기 위해 결과 타입 검사 로직 추가
   - 코루틴 반환 여부를 확인하고 올바르게 처리하는 코드 추가
   - 코루틴 체인에서 발생하는 타이밍 문제를 해결

3. **ID 타입 변환 오류 해결**
   - MongoDB ObjectId를 문자열로 변환하는 과정 개선으로 "404: News not found" 오류 해결
   - 트렌딩 뉴스 및 콜드 스타트 추천 기능에서 ID가 문자열로 일관되게 반환되도록 수정
   - `recommendation_service.py`에서 ID 처리 방식 표준화

4. **인증 API 경로 수정**
   - OAuth2 설정에서 tokenUrl을 "api/auth/login"에서 "auth/login"으로 수정
   - 프론트엔드 요청 경로와 일치하도록 수정하여 인증 절차 정상화

### 기술적 개선사항

1. **예외 처리 강화**
   - 비동기 작업에서 발생할 수 있는 예외를 더 철저히 포착하고 처리하도록 개선
   - 코루틴 처리에서 발생하는 예외 상황에 대한 대응 로직 강화

2. **타입 변환 일관성 향상**
   - MongoDB ObjectId와 문자열 ID 간 변환 로직을 일관되게 적용
   - 모든 ID 참조가 일관된 방식으로 처리되도록 표준화

## 2025-05-18 오류 수정 업데이트

### 수정된 주요 오류

1. **TrustAnalysisService의 analyze_trust 메서드 추가**
   - 신뢰도 분석 서비스에 누락된 `analyze_trust` 메서드를 추가하여 신뢰도 분석 기능이 정상 작동하도록 수정
   - 기존에는 `calculate_trust_score` 메서드만 있었고 API에서 호출하는 `analyze_trust` 메서드가 없어 오류 발생

2. **MongoDB 인덱스 중복 키 오류 해결**
   - MongoDB의 'news' 컬렉션에서 'id' 필드가 null인 중복 문서 처리 로직 추가
   - 인덱스 생성 전 null ID 문서를 찾아 임의의 UUID로 값 설정하는 방식으로 수정
   - 중복 키 오류 발생 시 인덱스를 삭제 후 다시 생성하는 복구 메커니즘 구현

3. **감정 분석 오류 수정**
   - `langchain_service.py`에서 'loop' 변수 미정의 오류 수정
   - asyncio 이벤트 루프 처리 로직 개선하여 안정적인 비동기 작업이 가능하도록 구현
   - 이벤트 루프 상태 확인 후 적절한 동작을 선택하는 방식으로 변경

4. **CORS 설정 오류 수정**
   - 모든 오리진에서의 API 요청을 허용하도록 CORS 설정 변경
   - 프론트엔드와의 통신 문제 해결

5. **뉴스 ID 조회 문제 해결**
   - 뉴스 상세 정보 조회 시 문자열 ID와 ObjectId 모두 시도하도록 수정
   - 다양한 형태의 ID 저장 방식에 대응할 수 있도록 조회 로직 개선

6. **카테고리 필터링 문제 해결**
   - 카테고리 필터링 시 배열 내 요소를 검색할 수 있도록 MongoDB 쿼리 수정
   - `$in` 연산자를 사용하여 카테고리 배열에 특정 값이 포함된 문서도 검색되도록 개선

7. **이미지 URL 문제 해결**
   - 유효하지 않은 이미지 URL을 사용하는 문제 해결
   - 이미지가 없는 경우 base64 인코딩된 기본 이미지를 제공하도록 수정

### 기술적 개선사항

1. **오류 처리 강화**
   - 주요 함수에 try-except 블록 추가하여 예외 상황에서도 서비스가 중단되지 않도록 개선
   - 오류 발생 시 로깅을 상세하게 하여 디버깅 용이성 향상

2. **백업 메커니즘 도입**
   - 주요 기능에 백업 처리 방식 구현
   - 주 기능 실패 시 대체 로직으로 전환하여 서비스 연속성 보장

3. **로깅 시스템 개선**
   - 주요 작업에 대한 로깅 추가로 문제 추적 용이성 향상
   - 오류 발생 시 상세 정보 기록

### 실행 방법

백엔드 서버 실행:
```bash
cd backend
bash start.sh
```

위 명령어는 필요한 의존성을 설치하고, 환경 설정을 확인한 후 서버를 실행합니다.
서버는 기본적으로 http://localhost:8000 에서 실행됩니다.
